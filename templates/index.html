<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Smart AI Traffic Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #020617;
      --bg-card: rgba(15, 23, 42, 0.85);
      --accent: #38bdf8;
      --border: rgba(148, 163, 184, 0.2);
      --danger: #ef4444;
      --success: #22c55e;
      --text-main: #f1f5f9;
      --text-sub: #94a3b8;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
      color: var(--text-main);
      font-family: 'Pretendard', -apple-system, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 25px;
      transition: all 0.3s ease;
    }

    body.danger-alert {
      box-shadow: inset 0 0 60px rgba(239, 68, 68, 0.45);
      border: 4px solid var(--danger);
    }

    .app-shell {
      width: 100%;
      max-width: 1650px;
      display: grid;
      grid-template-columns: 330px 1fr 330px;
      gap: 25px;
      align-items: start;
    }

    .card {
      background: var(--bg-card);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .monitor-box {
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      aspect-ratio: 16 / 9;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
    }
    .monitor-box img { width: 100%; height: 100%; object-fit: contain; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 15px;
      margin-top: 25px;
    }
    .stat-card {
      background: rgba(255,255,255,0.03);
      padding: 18px;
      border-radius: 15px;
      border: 1px solid var(--border);
      text-align: center;
    }
    .stat-card .val { font-size: 28px; font-weight: 800; color: var(--accent); }

    .log-container { height: 380px; overflow-y: auto; font-size: 13px; padding-right: 5px; }
    .log-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .log-item span:first-child { color: var(--danger); font-weight: 600; }

    input, select, button {
      width: 100%; 
      padding: 12px; 
      margin-bottom: 12px;
      border-radius: 10px; 
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.4); 
      color: #fff; 
      font-size: 14px;
      outline: none;
    }
    
    label {
      font-size: 13px;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 10px;
      display: block;
    }

    .btn-primary { 
      background: var(--accent); 
      color: #000; 
      font-weight: 800; 
      cursor: pointer; 
      border: none;
      margin-top: 10px;
    }

    #danger-tag { background: var(--danger); color: #fff; padding: 3px 10px; border-radius: 6px; font-size: 12px; font-weight: 800; }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

    @media (max-width: 1200px) {
      .app-shell { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body id="main-body">
  <div class="app-shell">
    
    <aside class="side-col">
      <div class="card" style="margin-bottom: 25px;">
        <div class="card-title">âš™ï¸ ë¶„ì„ ì»¨íŠ¸ë¡¤</div>
        <form action="/upload" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="model_path" value="{{ model_path or 'best.pt' }}">
          <input type="hidden" name="conf" value="{{ conf or 0.25 }}">
          <input type="hidden" name="iou" value="{{ iou or 0.45 }}">

          <label>ğŸ“ ë¶„ì„ ëŒ€ìƒ ì—…ë¡œë“œ</label>
          <input type="file" name="file" style="cursor: pointer;">
          
          <p style="font-size: 12px; color: var(--text-sub); line-height: 1.5; margin: 10px 0 20px 5px;">
            ì´ë¯¸ì§€ ë˜ëŠ” ì˜ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ AIê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ êµí†µ ìƒí™©ì„ ë¶„ì„í•©ë‹ˆë‹¤.
          </p>
          
          <button type="submit" class="btn-primary">ì‹¤ì‹œê°„ ë¶„ì„ ì‹œì‘</button>
        </form>
      </div>
      
      <div class="card">
        <div class="card-title">ğŸ“‰ íƒì§€ ì‹¤ì‹œê°„ ì¶”ì´</div>
        <canvas id="liveChart" height="220"></canvas>
      </div>
    </aside>

    <main class="main-col">
      <div class="card">
        <div class="card-title">
          <span>ğŸ–¥ï¸ ë¶„ì„ í”¼ë“œ ëª¨ë‹ˆí„°</span>
          <span id="danger-tag" style="display:none;">âš ï¸ ìœ„í—˜ ê°ì§€</span>
        </div>
        <div class="monitor-box">
          {% if stream_url %}<img src="{{ stream_url }}">
          {% elif image_url %}<img src="{{ image_url }}">
          {% else %}<p style="color:var(--text-sub);">ë¶„ì„í•  íŒŒì¼ì„ ì—…ë¡œë“œ í•´ì£¼ì„¸ìš”</p>{% endif %}
        </div>
        <div id="stats-summary" class="stats-grid"></div>
      </div>
    </main>

    <aside class="side-col">
      <div class="card" style="margin-bottom: 25px;">
        <div class="card-title">ğŸ”— ìŠ¤íŠ¸ë¦¼ ì—°ê²°</div>
        <form action="/set_url" method="POST">
          <label>CCTV / ë„¤íŠ¸ì›Œí¬ URL</label>
          <input type="text" name="source_url" placeholder="ì£¼ì†Œ ì…ë ¥" value="{{ source_url or '' }}">
          <button type="submit" class="btn-primary" style="background:var(--success)">ë¼ì´ë¸Œ ì—°ê²°</button>
        </form>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“œ íƒ€ì„ë¼ì¸ ë¡œê·¸</div>
        <div id="log-list" class="log-container"></div>
      </div>
    </aside>

  </div>

  <script>
    // [ê¸°ì¡´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€]
    const ctx = document.getElementById('liveChart').getContext('2d');
    const liveChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{ label: 'íƒì§€ ê°ì²´', data: [], borderColor: '#38bdf8', tension: 0.4, fill: true, backgroundColor: 'rgba(56,189,248,0.1)', pointRadius: 0 }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { display: false } }, plugins: { legend: { display: false } } }
    });

    function updateDashboard() {
      fetch('/get_counts')
        .then(res => res.json())
        .then(data => {
          const counts = data.counts;
          const hasDanger = data.has_danger;

          if (hasDanger) {
            document.body.classList.add('danger-alert');
            document.getElementById('danger-tag').style.display = 'inline';
          } else {
            document.body.classList.remove('danger-alert');
            document.getElementById('danger-tag').style.display = 'none';
          }

          let total = 0;
          let html = '';
          for (const [name, count] of Object.entries(counts)) {
            total += count;
            html += `<div class="stat-card"><div style="font-size:12px; color:var(--text-sub);">${name}</div><div class="val">${count}</div></div>`;
            if (name === "ë³´í–‰ì" || name === "ì‚¬ëŒ") addLog(`âš ï¸ ${name} ê°ì§€!`);
          }
          document.getElementById('stats-summary').innerHTML = html;

          const now = new Date().toLocaleTimeString();
          liveChart.data.labels.push(now);
          liveChart.data.datasets[0].data.push(total);
          if (liveChart.data.labels.length > 15) {
            liveChart.data.labels.shift();
            liveChart.data.datasets[0].data.shift();
          }
          liveChart.update('none');
        });
    }

    function addLog(msg) {
      const logList = document.getElementById('log-list');
      const item = document.createElement('div');
      item.className = 'log-item';
      item.innerHTML = `<span>${msg}</span><span style="color:var(--text-sub)">${new Date().toLocaleTimeString()}</span>`;
      logList.prepend(item);
      if (logList.childNodes.length > 30) logList.lastChild.remove();
    }

    setInterval(updateDashboard, 1000);
  </script>
</body>
</html>